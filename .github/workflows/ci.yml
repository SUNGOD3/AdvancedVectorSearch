name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  cpp-tests:
    uses: ./.github/workflows/setup.yml
    with:
      install-dev-deps: true

    steps:
      - name: Run C++ tests
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Debug ..
          make
          ctest
          
          # Generate C++ coverage report
          lcov --capture --directory . --output-file coverage.info
          lcov --remove coverage.info '/usr/*' --output-file coverage.info
          lcov --list coverage.info
          cd ..
      
      - name: Upload C++ Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: cpp-coverage-report
          path: build/coverage.info

  python-tests:
    uses: ./.github/workflows/setup.yml
    with:
      python-version: '3.9'
      install-dev-deps: true
    
    steps:
      - name: Run tests with coverage
        run: python tests/coverage_report.py
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: python-coverage-report
          path: |
            coverage_html
            coverage.xml

  benchmarks:
    uses: ./.github/workflows/setup.yml
    steps:
      - name: Run benchmarks
        run: python benchmarks/run_benchmarks.py
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmarks/results.json